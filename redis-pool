#!/usr/bin/env bash

# Brief: Create and keepalive N connections to Redis and bind each connection to a Unix socket
# Usage: ./redis-connection-pool [options] 
# Options:
#   -n <number of connections>
#   -b <socket base directory>
#   -h <host>
#   -p <port>
#   -a <passwd>
#   -t <idle timeout s>
#   -d <database no.>
# Redis non-error responses are served over the socket; error streams are logged in an stderr file.
# Use a connection from this pool:
# exec 3< redis-stderr-${id} # Open stderr  
# echo <Redis command> | nc -U redis-socket-${num} # Socket I/O
# read redis-stderr-${id} # Read error message, if any

. "${BASH_SOURCE%/*}/redis.bash"

  while getopts ':h:p:a:t:d:b:n:' opt;do
    case "${opt}" in
      h) REDIS_HOST="${OPTARG}";;
      p) REDIS_PORT="${OPTARG}";;
      a) REDIS_AUTH="${OPTARG}";;
      t) REDIS_TIMEOUT="${OPTARG}";;
      d) REDIS_DB="${OPTARG}";;
      b) base="${OPTARG}";;
      n) num_conn="${OPTARG}";;
      *) echo "Usage: ${0} -h <host> -p <port> -a <passwd> -t <idle timeout s> -d <database no.> -n <no. of connections> -b <dir path>" >&2; return 1;;
    esac
  done
  base="${base:-.}"
  mkdir -p "${base}"
  num_conn="${num_conn:-1}"

thread(){
  local id="${1:-0}"
  local socket="${base}/redis-socket-${id}"
  local stderr="${base}/redis-stderr-${id}"
  local pipe="${base}/.redis-pipe-${id}"
  local log="${base}/redis-log-${id}"
  mkfifo "${pipe}" 2>/dev/null
  rm -f "${socket}"

  ( trap "redis_disconnect; rm -f ${socket} ${stderr} ${pipe}" exit

  flock -n 2 || { echo "Failed to acquire thread lock" >&2 ; exit 23;}
  redis_connect || exit "$?"

  trap '' HUP
  trap 'exit' TERM QUIT INT
  echo "${BASHPID}" >&2

  while :; do
    {
    touch "${stderr}"
    if read -r cmd; then
      [[ "${cmd^^}" = @(QUIT|EXIT|Q) ]] && exit
    else
      continue
    fi

    redis_exec "${cmd}" 2>"${stderr}"
    local exitcode=$?
    case "${exitcode}" in
     0|1) rm -f "${stderr}" "${socket}" ;;
     *) cat "${stderr}" >>"${log}" ; exit "${exitcode}" ;;
    esac
    } < <(nc -U -l "${socket}" < "${pipe}") > "${pipe}"
  done
  ) 2> "${log}" &
}

for i in $(seq "${num_conn}"); do
  thread "${i}"
done
